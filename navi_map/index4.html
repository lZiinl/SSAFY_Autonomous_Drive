<!DOCTYPE html>
<html>
<head>
    <title>Map Visualization</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/roslibjs/1.1.0/roslib.min.js"></script>
    <!-- proj4.js 라이브러리 추가 (UTM 변환용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.5/proj4.js"></script>
</head>
<body>
    <div id="map" style="width: 1000px; height: 1000px;"></div>
    <script>
        // 지도를 초기화하고 중앙 좌표 및 확대 수준을 설정합니다.
        var map = L.map('map').setView([37.242768, 126.774465], 16);

        // 지도 타일을 추가합니다 (OpenStreetMap 사용).
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 16
        }).addTo(map);

        // ROS와 WebSocket으로 연결합니다.
        var ros = new ROSLIB.Ros({
            url: 'ws://192.168.56.101:9090'  // ROSBridge 서버의 IP 주소 및 포트
        });

        // /global_path 토픽 구독 설정
        var pathTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/global_path',  // 경로를 퍼블리시하는 토픽 이름
            messageType: 'nav_msgs/Path'  // 메시지 타입
        });

        // /gps 토픽 구독 설정 (실시간 차량 위치)
        var gpsTopic = new ROSLIB.Topic({
            ros: ros,
            name: '/gps',  // 차량 GPS 위치를 퍼블리시하는 토픽 이름
            messageType: 'morai_msgs/GPSMessage'  // 메시지 타입
        });

        // 경로 폴리라인을 저장할 변수
        var pathLine;
        var startMarker, endMarker; // 시작점과 끝점 마커를 저장할 변수
        var vehicleMarker; // 차량의 현재 위치 마커를 저장할 변수
        var mapCentered = false; // 지도의 초기 중심 설정 여부를 확인하는 변수
        var pathDisplayed = false; // 경로가 한 번 표시되었는지 확인하는 변수

        // 하드코딩된 Offset 값 (미리 확인한 값)
        var eastOffset = 302459.942;  // 예시로 적용된 Offset 값
        var northOffset = 4122635.537; // 예시로 적용된 Offset 값

        // 시작점과 끝점 아이콘 설정
        var originIcon = L.icon({
            iconUrl: 'origin.png',  // 시작점 아이콘 이미지
            iconSize: [75, 45],     // 아이콘 크기
            iconAnchor: [35, 40],   // 아이콘의 앵커 포인트
            popupAnchor: [0, 0]
        });

        var destinationIcon = L.icon({
            iconUrl: 'flag1.png',   // 끝점 아이콘 이미지
            iconSize: [35, 55],     // 아이콘 크기
            iconAnchor: [9, 75],    // 아이콘의 앵커 포인트
            popupAnchor: [0, -20]
        });

        // 차량 아이콘 설정
        var carIcon = L.icon({
            iconUrl: 'car.png',  // 차량 아이콘 이미지
            iconSize: [35, 55],  // 아이콘 크기
            iconAnchor: [15, 25],  // 아이콘의 앵커 포인트
            popupAnchor: [-15, -76]
        });

        // UTM 좌표를 GPS 좌표로 변환하는 함수 (Proj4 사용)
        function utmToLatLng(x, y, zone) {
            // Offset을 적용하여 UTM 좌표 조정
            x = x + eastOffset;
            y = y + northOffset;

            // Proj4를 사용하여 UTM 좌표를 WGS84 좌표로 변환
            var utmProj = `+proj=utm +zone=${zone} +ellps=WGS84 +datum=WGS84 +units=m +no_defs`;
            var wgs84Proj = '+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs';

            var latlng = proj4(utmProj, wgs84Proj, [x, y]);
            return [latlng[1], latlng[0]];  // [위도, 경도] 형식으로 반환
        }

        // /global_path 토픽에서 경로 데이터를 수신하여 처리
        pathTopic.subscribe(function(message) {
            if (!pathDisplayed) {  // 경로가 한 번도 표시되지 않았다면 표시
                var latlngs = [];

                // 각 경로 점들을 반복하면서 UTM 좌표를 GPS 좌표로 변환해 latlngs 배열에 저장합니다.
                message.poses.forEach(function(pose) {
                    var x = pose.pose.position.x;
                    var y = pose.pose.position.y;

                    // UTM 좌표를 GPS 좌표로 변환 (52 zone 사용)
                    var latlng = utmToLatLng(x, y, 52);
                    latlngs.push(latlng);
                });

                // 새로운 경로를 폴리라인으로 추가하고 지도에 표시합니다.
                pathLine = L.polyline(latlngs, { color: 'red', weight : 5 }).addTo(map);

                // 경로가 지도에 잘 보이도록 지도의 범위를 경로에 맞춰 조정합니다.
                map.fitBounds(pathLine.getBounds());

                // 시작점과 끝점 추가
                if (latlngs.length > 0) {
                    var startLatLng = latlngs[0];  // 경로의 첫 번째 점 (시작점)
                    var endLatLng = latlngs[latlngs.length - 1];  // 경로의 마지막 점 (끝점)

                    // 시작점 마커 추가
                    //startMarker = L.marker(startLatLng, {
                    //    title: "출발점",
                    //    icon: originIcon
                    //}).addTo(map);

                    // 끝점 마커 추가
                    endMarker = L.marker(endLatLng, {
                        title: "도착점",
                        icon: destinationIcon
                    }).addTo(map);

                    // 시작점과 끝점 콘솔에 출력
                    console.log("시작점 위치: ", startLatLng);
                    console.log("끝점 위치: ", endLatLng);
                }

                // 경로가 한 번 표시되었음을 기록하고 구독 중단
                //pathDisplayed = true;
                //pathTopic.unsubscribe();  // 한 번 경로를 표시한 후 구독 중단
            }
        });

        // /gps 토픽에서 실시간 차량 위치 수신
        gpsTopic.subscribe(function(gps_msg) {
            var lat = gps_msg.latitude;
            var lon = gps_msg.longitude;

            // 차량의 현재 위치를 나타내는 마커가 아직 없다면 추가
            if (!vehicleMarker) {
                vehicleMarker = L.marker([lat, lon], {
                    icon: carIcon,
                    title: "현재 위치"
                }).addTo(map);
            } else {
                // 기존 마커가 있으면 위치만 갱신
                vehicleMarker.setLatLng([lat, lon]);
            }

            // 차량 위치 콘솔에 출력
            console.log("차량 위치: ", { lat: lat, lon: lon });

            // 지도의 중심을 처음 차량 위치 수신 시에만 이동
            if (!mapCentered) {
                map.setView([lat, lon], 16);
                mapCentered = true;  // 한번 지도를 중앙으로 설정하면 더 이상 이동하지 않음
            }
        });

    </script>
</body>
</html>
